# COMPLETE SYNCED ROLLUP SYSTEM
# Recovered from legacy synced_rollups.py (587 lines)

rollup_system:
  enabled: true
  auto_sync: true
  sync_frequency: "real_time"
  cache_enabled: true
  cache_ttl: 300  # 5 minutes

# CROSS-DATABASE ROLLUPS - Complete Implementation
cross_database_rollups:
  # MASTER ESTATE COMPLETION ROLLUP
  estate_completion_master:
    name: "Master Estate Completion Tracking"
    source_databases:
      - database_id: "financial_tasks"
        alias: "financial"
        completion_property: "Status"
        weight: 0.4  # 40% of total weight
      - database_id: "legal_tasks"
        alias: "legal"
        completion_property: "Status"
        weight: 0.3  # 30% of total weight
      - database_id: "personal_tasks"
        alias: "personal"
        completion_property: "Status"
        weight: 0.2  # 20% of total weight
      - database_id: "digital_tasks"
        alias: "digital"
        completion_property: "Status"
        weight: 0.1  # 10% of total weight
    rollup_calculations:
      total_completion_percentage:
        type: "weighted_average"
        formula: |
          (financial.completion_rate * 0.4) +
          (legal.completion_rate * 0.3) +
          (personal.completion_rate * 0.2) +
          (digital.completion_rate * 0.1)
        target_property: "Overall_Completion"
      tasks_by_status:
        type: "aggregate_count"
        grouping: "status"
        statuses: ["✅ Complete", "🟡 In Progress", "⚪ Not Started", "🔴 Blocked"]
      estimated_completion_date:
        type: "projected_date"
        based_on: "current_velocity"
        velocity_window: "30_days"
        target_property: "Estimated_Done_Date"

  # PRIORITY TASK ROLLUP
  priority_tasks_rollup:
    name: "High Priority Task Aggregation"
    source_databases:
      - database_id: "financial_tasks"
        filter:
          property: "Priority"
          condition: "equals"
          value: "🔴 High"
      - database_id: "legal_tasks"
        filter:
          property: "Priority"
          condition: "equals"
          value: "🔴 High"
      - database_id: "personal_tasks"
        filter:
          property: "Priority"
          condition: "equals"
          value: "🔴 High"
    rollup_calculations:
      high_priority_completion:
        type: "completion_percentage"
        target_property: "High_Priority_Progress"
      overdue_high_priority:
        type: "count"
        filter:
          property: "Due_Date"
          condition: "before"
          value: "today()"
        target_property: "Overdue_High_Priority_Count"

  # TIME-BASED ANALYTICS ROLLUP
  time_analytics_rollup:
    name: "Time and Velocity Analytics"
    source_databases: ["financial_tasks", "legal_tasks", "personal_tasks", "digital_tasks"]
    rollup_calculations:
      average_completion_time:
        type: "average_duration"
        start_property: "Created_Date"
        end_property: "Completed_Date"
        filter:
          property: "Status"
          condition: "equals"
          value: "✅ Complete"
        target_property: "Avg_Task_Duration"
      weekly_completion_velocity:
        type: "time_series_count"
        time_grouping: "weekly"
        property: "Completed_Date"
        weeks_back: 12
        target_property: "Weekly_Velocity_Data"
      bottleneck_categories:
        type: "slowest_categories"
        category_property: "Category"
        duration_calculation: "average_time_to_complete"
        target_property: "Slowest_Categories"

# FORMULA SYNCHRONIZATION SYSTEM - Complete Implementation
formula_sync:
  enabled: true
  auto_propagate: true
  formulas:
    # COMPLETION PERCENTAGE FORMULA
    completion_percentage:
      name: "Standard Completion Percentage"
      formula_text: |
        if(
          prop("Total_Tasks") > 0,
          round(
            prop("Completed_Tasks") / prop("Total_Tasks") * 100
          ),
          0
        )
      target_databases: ["financial_tasks", "legal_tasks", "personal_tasks", "digital_tasks"]
      target_property: "Completion_Percentage"
      dependencies: ["Total_Tasks", "Completed_Tasks"]

    # PROGRESS STATUS FORMULA
    progress_status:
      name: "Dynamic Progress Status"
      formula_text: |
        if(
          prop("Completion_Percentage") == 100,
          "✅ Complete",
          if(
            prop("Completion_Percentage") >= 75,
            "🟢 Nearly Done",
            if(
              prop("Completion_Percentage") >= 50,
              "🟡 In Progress",
              if(
                prop("Completion_Percentage") > 0,
                "🔄 Started",
                "⚪ Not Started"
              )
            )
          )
        )
      target_databases: ["financial_tasks", "legal_tasks", "personal_tasks", "digital_tasks"]
      target_property: "Progress_Status"
      dependencies: ["Completion_Percentage"]

    # ESTIMATED COMPLETION FORMULA
    estimated_completion:
      name: "Estimated Completion Date"
      formula_text: |
        if(
          and(
            prop("Completion_Percentage") < 100,
            prop("Weekly_Velocity") > 0
          ),
          dateAdd(
            now(),
            ceil(
              prop("Remaining_Tasks") / prop("Weekly_Velocity")
            ) * 7,
            "days"
          ),
          if(
            prop("Completion_Percentage") == 100,
            prop("Actual_Completion_Date"),
            empty()
          )
        )
      target_databases: ["financial_tasks", "legal_tasks", "personal_tasks", "digital_tasks"]
      target_property: "Estimated_Completion_Date"
      dependencies: ["Completion_Percentage", "Weekly_Velocity", "Remaining_Tasks", "Actual_Completion_Date"]

# ANALYTICS VIEWS SYSTEM - Complete Implementation
analytics_views:
  # EXECUTIVE DASHBOARD VIEW
  executive_dashboard:
    name: "Executive Analytics Dashboard"
    description: "High-level metrics for decision makers"
    layout:
      type: "grid"
      columns: 2
      rows: 2
    components:
      overall_progress_card:
        type: "metric_card"
        position: [1, 1]
        data_source: "estate_completion_master"
        metric: "total_completion_percentage"
        display:
          title: "Overall Progress"
          format: "percentage"
          trend: "weekly_change"
          target: 100
        content_template: |
          📊 **Overall Estate Planning Progress**

          {{percentage}}% Complete
          {{trend_indicator}} {{trend_text}} this week

          **Target**: {{target}}% | **Current**: {{percentage}}%
          **Estimated Completion**: {{estimated_date}}

      category_breakdown_chart:
        type: "progress_chart"
        position: [2, 1]
        data_source: "estate_completion_master"
        chart_type: "horizontal_bar"
        content_template: |
          📈 **Progress by Category**

          Financial  {{financial_bar}} {{financial_pct}}%
          Legal      {{legal_bar}} {{legal_pct}}%
          Personal   {{personal_bar}} {{personal_pct}}%
          Digital    {{digital_bar}} {{digital_pct}}%

      priority_tasks_alert:
        type: "alert_card"
        position: [1, 2]
        data_source: "priority_tasks_rollup"
        alert_conditions:
          - condition: "overdue_high_priority > 0"
            level: "critical"
            message: "{{count}} high priority tasks overdue"
          - condition: "high_priority_completion < 50"
            level: "warning"
            message: "High priority tasks behind schedule"
        content_template: |
          ⚠️ **Priority Task Status**

          High Priority: {{high_priority_progress}}% complete
          {{#alerts}}
          {{icon}} {{message}}
          {{/alerts}}

      velocity_trend:
        type: "trend_chart"
        position: [2, 2]
        data_source: "time_analytics_rollup"
        chart_type: "line_chart"
        time_period: "12_weeks"
        content_template: |
          📈 **Completion Velocity Trend**

          {{velocity_chart}}

          Current: {{current_velocity}} tasks/week
          Average: {{average_velocity}} tasks/week

  # DETAILED ANALYTICS VIEW
  detailed_analytics:
    name: "Detailed Progress Analytics"
    description: "Comprehensive analytics for active management"
    layout:
      type: "list"
      sections: ["completion", "time", "bottlenecks", "forecasting"]
    components:
      completion_analysis:
        section: "completion"
        type: "detailed_breakdown"
        data_source: "estate_completion_master"
        content_template: |
          ## 📊 Completion Analysis

          **Overall Progress**: {{overall_percentage}}%
          **Weighted Score**: {{weighted_score}}/100

          ### By Category:
          {{#categories}}
          **{{name}}** ({{weight}}% weight): {{percentage}}% complete
          - Tasks: {{completed}}/{{total}}
          - Weight Contribution: {{weighted_contribution}}%
          - Status: {{status_indicator}} {{status_text}}

          {{/categories}}

      time_analysis:
        section: "time"
        type: "time_metrics"
        data_source: "time_analytics_rollup"
        content_template: |
          ## ⏱️ Time & Velocity Analysis

          **Average Task Duration**: {{avg_duration}} days
          **Current Velocity**: {{current_velocity}} tasks/week
          **Projected Completion**: {{projected_date}}

          ### Weekly Velocity Trend:
          {{velocity_trend_chart}}

          ### Completion Times by Category:
          {{#categories}}
          **{{name}}**: {{avg_time}} days average
          {{/categories}}

      bottleneck_analysis:
        section: "bottlenecks"
        type: "bottleneck_identification"
        data_source: "time_analytics_rollup"
        content_template: |
          ## 🚧 Bottleneck Analysis

          ### Slowest Categories:
          {{#bottlenecks}}
          {{rank}}. **{{category}}**: {{avg_duration}} days
          {{bottleneck_indicator}} {{bottleneck_reason}}

          {{/bottlenecks}}

          ### Recommendations:
          {{#recommendations}}
          - {{recommendation_text}}
          {{/recommendations}}

# CHANGE DETECTION SYSTEM - Complete Implementation
change_detection:
  enabled: true
  monitoring:
    database_changes:
      - database: "financial_tasks"
        properties: ["Status", "Priority", "Due_Date"]
        actions: ["update_rollups", "recalculate_estimates"]
      - database: "legal_tasks"
        properties: ["Status", "Priority", "Due_Date"]
        actions: ["update_rollups", "recalculate_estimates"]
      - database: "personal_tasks"
        properties: ["Status", "Priority", "Due_Date"]
        actions: ["update_rollups", "recalculate_estimates"]
      - database: "digital_tasks"
        properties: ["Status", "Priority", "Due_Date"]
        actions: ["update_rollups", "recalculate_estimates"]

  propagation_rules:
    status_change:
      trigger: "task_status_updated"
      affected_calculations: ["completion_percentage", "progress_status", "estimated_completion"]
      cascade_updates: true
      update_delay: "immediate"

    priority_change:
      trigger: "task_priority_updated"
      affected_calculations: ["priority_tasks_rollup"]
      cascade_updates: true
      update_delay: "immediate"

    bulk_updates:
      trigger: "multiple_task_changes"
      threshold: 5  # If 5+ tasks change at once
      affected_calculations: ["all"]
      cascade_updates: true
      update_delay: "batched_5min"  # Batch for performance

# CACHING & OPTIMIZATION - Complete Implementation
optimization:
  caching:
    enabled: true
    cache_levels:
      rollup_results:
        ttl: 300  # 5 minutes
        invalidation: "property_change"
      formula_calculations:
        ttl: 180  # 3 minutes
        invalidation: "dependency_change"
      analytics_views:
        ttl: 600  # 10 minutes
        invalidation: "scheduled"

  performance:
    batch_updates:
      enabled: true
      batch_size: 10
      batch_interval: 60  # 1 minute

    incremental_updates:
      enabled: true
      track_changes: true
      update_only_affected: true

    background_processing:
      enabled: true
      low_priority_updates: ["historical_analytics", "trend_calculations"]
      schedule: "off_peak_hours"

# ERROR HANDLING & RECOVERY - Complete Implementation
error_handling:
  retry_logic:
    max_retries: 3
    backoff_strategy: "exponential"
    base_delay: 1000  # 1 second
    max_delay: 10000  # 10 seconds

  fallback_behavior:
    calculation_failure: "use_cached_value"
    data_unavailable: "skip_calculation"
    sync_failure: "queue_retry"

  monitoring:
    error_logging: true
    performance_metrics: true
    sync_status_tracking: true
    alert_thresholds:
      error_rate: 0.05  # 5%
      sync_delay: 300   # 5 minutes
      cache_hit_rate: 0.8  # 80%
