<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotional Intelligence Configuration - Estate Planning v4.0</title>
    
    <!-- Local Bootstrap CSS -->
    <link href="{{ url_for('static', filename='lib/bootstrap/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="{{ url_for('static', filename='lib/font-awesome/css/all.min.css') }}" rel="stylesheet">
    <!-- Custom Emotional Config CSS -->
    <link href="{{ url_for('static', filename='css/emotional_config.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Header Section -->
    <div class="config-header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-2">
                                <i class="fas fa-brain me-3"></i>
                                Emotional Intelligence Configuration
                            </h1>
                            <p class="mb-0 opacity-90">
                                Configure emotional tones and visual elements for Estate Planning v4.0 asset generation
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="btn-group" role="group" aria-label="Main actions">
                                <button type="button" class="btn btn-light btn-lg" id="load-config-btn" aria-label="Load configuration from server">
                                    <i class="fas fa-download me-2"></i>Load
                                </button>
                                <button type="button" class="btn btn-warning btn-lg" id="save-config-btn" aria-label="Save current configuration">
                                    <i class="fas fa-save me-2"></i>Save
                                </button>
                                <button type="button" class="btn btn-danger btn-lg" id="reset-defaults-btn" aria-label="Reset configuration to defaults">
                                    <i class="fas fa-undo me-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Emotional Tones Section -->
            <div class="col-lg-8">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-palette me-2"></i>
                            Emotional Tones
                        </h2>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" id="preview-changes-btn" aria-label="Preview configuration changes">
                                <i class="fas fa-eye me-1"></i>Preview Changes
                            </button>
                            <button type="button" class="btn btn-outline-success" id="generate-test-btn" aria-label="Generate test assets">
                                <i class="fas fa-magic me-1"></i>Generate Test Assets
                            </button>
                        </div>
                    </div>
                    
                    <!-- Emotional Tones Container -->
                    <div id="emotional-tones-container" class="row" role="region" aria-label="Emotional tones configuration">
                        <!-- Tone cards will be dynamically generated here -->
                        <div class="col-12 text-center py-5 text-muted">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading emotional tones configuration...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Style Elements Section -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-paint-brush me-2"></i>
                            Visual Style Elements
                        </h2>
                        <small class="text-muted">Configure visual elements that enhance emotional impact</small>
                    </div>
                    
                    <!-- Style Elements Container -->
                    <div id="style-elements-container" class="row" role="region" aria-label="Visual style elements configuration">
                        <!-- Style category cards will be dynamically generated here -->
                        <div class="col-12 text-center py-5 text-muted">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading style elements configuration...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview and Tools Sidebar -->
            <div class="col-lg-4">
                <!-- Configuration Tools -->
                <div class="config-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-tools me-2"></i>
                            Configuration Tools
                        </h3>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" id="export-config-btn" aria-label="Export configuration to file">
                            <i class="fas fa-file-export me-2"></i>Export Configuration
                        </button>
                        
                        <div class="input-group">
                            <input type="file" class="form-control" id="import-config-input" accept=".json,.yaml,.yml" aria-label="Import configuration file">
                            <button class="btn btn-outline-secondary" type="button" id="import-config-btn" aria-label="Import configuration from file">
                                <i class="fas fa-file-import"></i>
                            </button>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-save-toggle" aria-describedby="auto-save-help">
                            <label class="form-check-label" for="auto-save-toggle">
                                Auto-save changes
                            </label>
                            <div id="auto-save-help" class="form-text">Automatically save changes after 2 seconds of inactivity</div>
                        </div>
                        
                        <button type="button" class="btn btn-outline-info" id="health-check-btn" aria-label="Check system health">
                            <i class="fas fa-heartbeat me-2"></i>System Health Check
                        </button>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="config-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-search me-2"></i>
                            Configuration Preview
                        </h3>
                    </div>
                    
                    <!-- Preview Container -->
                    <div id="preview-container" role="region" aria-label="Configuration preview">
                        <div class="preview-area text-center py-4">
                            <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                            <p class="text-muted mb-0">
                                Click "Preview Changes" to see how your configuration affects prompt generation
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="config-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-question-circle me-2"></i>
                            Help & Information
                        </h3>
                    </div>
                    
                    <div class="accordion accordion-flush" id="help-accordion">
                        <!-- Emotional Tones Help -->
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="help-tones-heading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#help-tones-collapse" aria-expanded="false" 
                                        aria-controls="help-tones-collapse">
                                    About Emotional Tones
                                </button>
                            </h4>
                            <div id="help-tones-collapse" class="accordion-collapse collapse" 
                                 aria-labelledby="help-tones-heading" data-bs-parent="#help-accordion">
                                <div class="accordion-body">
                                    <p><strong>Emotional Tones</strong> define the emotional character of generated assets:</p>
                                    <ul class="small">
                                        <li><strong>Warm Welcome:</strong> Entry points - welcoming and accessible</li>
                                        <li><strong>Trusted Guide:</strong> Executor sections - reliable and professional</li>
                                        <li><strong>Family Heritage:</strong> Family sections - warmth and connection</li>
                                        <li><strong>Secure Protection:</strong> Financial/legal - safety emphasis</li>
                                        <li><strong>Peaceful Transition:</strong> Difficult topics - gentle approach</li>
                                        <li><strong>Living Continuity:</strong> Legacy sections - enduring impact</li>
                                        <li><strong>Tech Bridge:</strong> Digital sections - modern accessibility</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Style Elements Help -->
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="help-style-heading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#help-style-collapse" aria-expanded="false" 
                                        aria-controls="help-style-collapse">
                                    About Style Elements
                                </button>
                            </h4>
                            <div id="help-style-collapse" class="accordion-collapse collapse" 
                                 aria-labelledby="help-style-heading" data-bs-parent="#help-accordion">
                                <div class="accordion-body">
                                    <p><strong>Style Elements</strong> enhance emotional impact through visual design:</p>
                                    <ul class="small">
                                        <li><strong>Materials:</strong> Physical textures and surfaces</li>
                                        <li><strong>Lighting:</strong> Atmospheric and mood lighting</li>
                                        <li><strong>Colors:</strong> Emotional color palettes</li>
                                        <li><strong>Textures:</strong> Surface treatments and finishes</li>
                                        <li><strong>Objects:</strong> Symbolic items and artifacts</li>
                                        <li><strong>Composition:</strong> Layout and arrangement principles</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Keyboard Shortcuts Help -->
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="help-shortcuts-heading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#help-shortcuts-collapse" aria-expanded="false" 
                                        aria-controls="help-shortcuts-collapse">
                                    Keyboard Shortcuts
                                </button>
                            </h4>
                            <div id="help-shortcuts-collapse" class="accordion-collapse collapse" 
                                 aria-labelledby="help-shortcuts-heading" data-bs-parent="#help-accordion">
                                <div class="accordion-body">
                                    <ul class="small">
                                        <li><kbd>Ctrl+S</kbd> / <kbd>⌘+S</kbd> - Save configuration</li>
                                        <li><kbd>Ctrl+L</kbd> / <kbd>⌘+L</kbd> - Load configuration</li>
                                        <li><kbd>Ctrl+P</kbd> / <kbd>⌘+P</kbd> - Preview changes</li>
                                        <li><kbd>Escape</kbd> - Cancel current operation</li>
                                        <li><kbd>Enter</kbd> - Add keyword/element (in input fields)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal Template -->
    <div class="modal fade" id="confirmation-modal" tabindex="-1" aria-labelledby="confirmation-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmation-modal-label">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmation-modal-message">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmation-modal-confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries (Local) -->
    <script src="{{ url_for('static', filename='lib/bootstrap/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/js-yaml/js-yaml.min.js') }}"></script>
    
    <!-- Modular JavaScript Architecture -->
    <script src="{{ url_for('static', filename='js/modules/data-validator.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/api-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/ui-notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/dom-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/event-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/emotional-config-manager.js') }}"></script>

    <!-- Application Initialization -->
    <script>
        // Global application instance
        let emotionalConfigApp = null;

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing Emotional Config Application...');
                
                // Create main application instance
                emotionalConfigApp = new EmotionalConfigManager();
                
                // Initialize the application
                await emotionalConfigApp.initialize();
                
                // Setup additional event handlers
                setupAdditionalHandlers();
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Application initialization failed:', error);
                
                // Show fallback error message
                const container = document.getElementById('emotional-tones-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Initialization Failed</h4>
                                <p>The emotional intelligence configuration system failed to initialize.</p>
                                <hr>
                                <p class="mb-0">Error: ${error.message}</p>
                                <button class="btn btn-outline-danger btn-sm mt-2" id="error-retry-btn">
                                    <i class="fas fa-redo me-1"></i>Retry
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for retry button
                    const retryBtn = container.querySelector('#error-retry-btn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', function() {
                            location.reload();
                        });
                    }
                }
            }
        });

        // Setup additional event handlers not managed by modules
        function setupAdditionalHandlers() {
            // Export configuration
            document.getElementById('export-config-btn')?.addEventListener('click', function() {
                if (emotionalConfigApp) {
                    emotionalConfigApp.exportConfiguration();
                }
            });

            // Import configuration
            const importInput = document.getElementById('import-config-input');
            const importBtn = document.getElementById('import-config-btn');
            
            importBtn?.addEventListener('click', function() {
                importInput?.click();
            });

            importInput?.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && emotionalConfigApp) {
                    emotionalConfigApp.importConfiguration(file);
                }
                // Clear input to allow re-importing the same file
                event.target.value = '';
            });

            // Auto-save toggle
            document.getElementById('auto-save-toggle')?.addEventListener('change', function(event) {
                if (emotionalConfigApp) {
                    emotionalConfigApp.setAutoSave(event.target.checked);
                }
            });

            // Health check
            document.getElementById('health-check-btn')?.addEventListener('click', async function() {
                if (emotionalConfigApp) {
                    const health = await emotionalConfigApp.getHealthStatus();
                    const status = health.healthy ? 'System is healthy' : `System issues detected: ${health.error}`;
                    const type = health.healthy ? 'success' : 'error';
                    emotionalConfigApp.uiNotifications.showToast(status, type);
                }
            });
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (emotionalConfigApp && emotionalConfigApp.uiNotifications) {
                emotionalConfigApp.uiNotifications.showError(`Unexpected error: ${event.error.message}`);
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (emotionalConfigApp && emotionalConfigApp.uiNotifications) {
                emotionalConfigApp.uiNotifications.showError(`Promise rejection: ${event.reason}`);
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (emotionalConfigApp) {
                emotionalConfigApp.cleanup();
            }
        });
    </script>
</body>
</html>